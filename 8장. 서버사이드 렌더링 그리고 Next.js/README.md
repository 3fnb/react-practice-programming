# 서버사이드 렌더링 그리고 Next.js

서버에서 리액트 코드를 실행해서 렌더링 하는 서버사이드 렌더링.

1. SEO를 해야 한다.
2. 빠른 첫 페이지 렌더링이 중요하다.

라는 조건일 때 고려한다.

사실 구글을 제외한 다른 검색엔진에선 자바스크립트를 지원하지 않아, 빈 div만 있는 사이트와 동일하다.  
따라서 SEO를 신경쓴다면 SSR을 생각해야 한다. 구글 검색엔진도 SSR에 더 높은 점수를 부여한다고 알려져있다.  
또한 서버에서 미리 첫 페이지를 렌더링 하기에 인터넷 속도가 느린 네트워크 인프라가 약한 나라에서 서비스 해야한다면 SSR을 고려하는게 좋다.  
Next라는 프레임워크 없이 처음엔 react로 직접 SSR을 구축해보자.

## SSR 초급편

next없이 웹팩과 바벨로 SSR을 하고 싶다면,

1.  `express`로 노드 서버를 띄워 `renderToString`함수의 도움을 받아 `html`을 미리 완성시킨다.
2.  `ReactDom.render` 가 아닌 `ReactDom.hydrate`를 통해 이벤트 처리 함수를 붙여줘 SSR에서 CSR로 전환시킨다.

두가지 과정만 거치면 된다.

만약 js파일만 번들링 한것이라면 client쪽에서만 웹팩을 활용해 번들링 해도 상관 없는데, 다른 파일들을 모듈로 적용시키려면 server까지 웹팩을 활용해 파일의 경로를 맞춰줘야 한다.  
파일의 경로가 달라지면 파일을 client에서 정상적으로 활용할 수 없다.

### 클라이언트에서만 렌더링

웹팩을 설정해준다.

1. js파일은 바벨 로더로 처리한다.
2. `HtmlWebpackPlugin`을 통해 `index.html`의 템플릿을 정해준다.

바벨을 설정해준다.

- 프리셋으로 `@babel/preset-react`, `@babel/preset-env`를 설정해준다.

### express로 서버 만들기

서버에서도 JSX문법을 실행해야해서,ESM을 써야해서 바벨이 필요하다.  
서버와 클라이언트에서 쓰는 바벨 설정이 다르므로 .bablerc.common과 client,server로 분리해준다.

`server.js`를 만들고 서버 관련 코드를 작성한다.  
웹팩을 통해 클라이언트에서 빌드된 index.html를 가져오고, 최상위 컴포넌트 App을 가져와 renderToString함수로 변환하고, index.html에 넣어준다.
이제 `index.js`에서 ReactDom.render 를 hydrate로 바꿔준다.

### 서버의 데이터 전달

클라이언트에서 빌드된 html을 가져와서 미리 랜더링을 시켜주는게 SSR이다.  
html을 가져와 여러가지를 할 수 있는데, 빌드되기 전 html 템플릿에 상수를 미리 작성해두고, 서버에서 renderToString 시킬때 같이 replace를 시켜주는 방식으로 서버->클라이언트 데이터 전송이 일어난다.

<br>

클라이언트에서 받아쓸땐 window객체의 프로퍼티를 활용한다.

### 스타일 적용

css-in-js 방식의 경우, 서버에서 작업을 해두지 않는다면 깜빡거림이 발생한다.  
따라서 `server.js`에서 추가적인 작업이 필요하다.

### 이미지 모듈 적용

서버 코드도 웹팩으로 번들링 하기 위해선 webpack.config를 변경해야한다.  
webpack.config 안에 함수를 만들어 조건부로 달라지는 객체를 반환시킨 후, `module.exports`에 배열로 두개의 원소를 넣어주면 두번 실행된다. 웹팩설정파일에서 배열을 내보낼 경우 length만큼 실행된다.
